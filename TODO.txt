Factor out common code in the metadata service.
