#import(software.altitude.core.Const)
#import(software.altitude.core.RequestContext)
#import(software.altitude.core.util.Util)

<style>
    #uploadForm {
        display: grid;
        grid-auto-rows: auto;
        grid-row-gap: calc(var(--control-vertical-space) * 1.5);
    }

    #uploadForm div {
        text-align: center;
    }

    #uploadForm progress {
        width: 100%;
    }

    #uploadForm input[type="file"] {
        background-color: var(--form-background-color);
        color: #FFFFFF;
    }

    #uploadForm button {
        font-size: 1.2em;
    }

    #abortUploadButtonControl {
        display: none;
    }

</style>

<%@ val uploadId: String = Util.randomStr() %>

<form id="uploadForm" hx-post='${ url(uploadFilesForm, Const.Api.REPO_ID -> RequestContext.getRepository.persistedId, Const.Api.Upload.UPLOAD_ID -> uploadId) }' hx-encoding="multipart/form-data">
    <div>
        <input type="file" name="files" id="files" multiple>
    </div>

    <div id="progressBarControl" hidden>
        <progress id='progressBar' value='0' max='100'></progress>
    </div>

    <div id="progressTextControl" hidden>
    </div>

    <div id="startUploadButtonControl">
        <button class="action-button">Upload from computer</button>
    </div>

    <script>
        htmx.on('#uploadForm', 'htmx:xhr:progress', function(evt) {
            htmx.find("#progressBarControl").removeAttribute("hidden")
            htmx.find('#progressBar').setAttribute('value', evt.detail.loaded/evt.detail.total * 100)
            htmx.find('#startUploadButtonControl').setAttribute('hidden', true)
            htmx.find('#files').setAttribute('disabled', true)

            htmx.find("#progressTextControl").removeAttribute("hidden")
            const percentLoaded = parseInt((evt.detail.loaded / evt.detail.total) * 100)
            htmx.find("#progressTextControl").innerText = percentLoaded+ "%"

            if (percentLoaded === 100) {
                htmx.find("#progressBarControl").setAttribute('hidden', true)
                htmx.find('#startUploadButtonControl').setAttribute('hidden', false)
                htmx.find('#files').setAttribute('disabled', false)
            }
        });


    </script>
</form>
